{
  "content": "# SPDX-License-Identifier: LGPL-3.0-or-later\n# Copyright (C) 2025-2026 Kris Kirby, KE4AHR\n\n\"\"\"\npyax25_22.core.validation.py\n\nComprehensive validation utilities for AX.25 v2.2 compliance.\n\nProvides detailed frame validation beyond basic decoding:\n- Address field rules (digipeater count, reserved bits)\n- Control field compliance per frame type and modulo\n- PID presence/absence rules\n- Information field length vs N1\n- Protocol-specific checks (e.g., U-frame commands)\n\nAll validation functions raise specific exceptions on failure and log details.\n\"\"\"\n\nfrom __future__ import annotations\n\nimport logging\nfrom typing import Optional\n\nfrom .framing import AX25Frame\nfrom .config import AX25Config\nfrom .exceptions import (\n    FrameError,\n    InvalidControlFieldError,\n    InvalidAddressError,\n)\n\nlogger = logging.getLogger(__name__)\n\n\ndef validate_frame_structure(frame: AX25Frame, config: Optional[AX25Config] = None) -> None:\n    \"\"\"\n    Perform structural validation of a decoded AX.25 frame.\n\n    Validates:\n    - Address field rules\n    - Control field format and PID presence\n    - Information field length\n    - Digipeater count\n\n    Args:\n        frame: Decoded AX.25 frame\n        config: Configuration for N1 and modulo checks\n\n    Raises:\n        FrameError, InvalidControlFieldError, InvalidAddressError on failure\n    \"\"\"\n    config = config or frame.config\n\n    # Digipeater count limit\n    if len(frame.digipeaters) > 8:\n        raise InvalidAddressError(f\"Too many digipeaters: {len(frame.digipeaters)} > 8\")\n\n    control = frame.control\n\n    # I-frame validation\n    if control & 0x01 == 0x00:\n        if frame.pid is None:\n            raise InvalidControlFieldError(\"I-frame must have PID\")\n        if len(frame.info) > config.max_frame:\n            raise FrameError(f\"I-field {len(frame.info)} exceeds N1={config.max_frame}\")\n\n    # S-frame validation\n    elif control & 0x03 == 0x01:\n        if frame.pid is not None:\n            raise InvalidControlFieldError(\"S-frame must not have PID\")\n        if frame.info:\n            raise FrameError(\"S-frame must not have info field\")\n\n    # U-frame validation\n    elif control & 0x03 == 0x03:\n        # UI frames must have PID\n        if (control & ~0x10) == 0x03:  # UI\n            if frame.pid is None:\n                raise InvalidControlFieldError(\"UI frame must have PID\")\n        else:\n            # Other U-frames must not have PID\n            if frame.pid is not None:\n                raise InvalidControlFieldError(f\"U-frame type {control:02x} must not have PID\")\n\n    logger.debug(\"Frame structure validation passed\")\n\n\ndef full_validation(frame: AX25Frame, config: Optional[AX25Config] = None) -> None:\n    \"\"\"\n    Perform complete AX.25 v2.2 validation on a decoded frame.\n\n    Called after successful decode and FCS check.\n\n    Args:\n        frame: Decoded frame\n        config: Configuration context\n\n    Raises:\n        Specific exceptions on any validation failure\n    \"\"\"\n    validate_frame_structure(frame, config)\n    logger.info(\"Full frame validation completed successfully\")\n\n__all__ = [\n    \"validate_frame_structure\",\n    \"full_validation\",\n]"
}
